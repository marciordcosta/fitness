<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Galeria</title>

<link rel="stylesheet" href="style.css" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
  /* --- visual minimal identico ao seu original --- */
  body{ background:#000; color:#fff; margin:0; font-family:Arial, Helvetica, sans-serif; min-height:100vh; }
  .galeria-header{ padding:12px 16px; position:fixed; top:0; left:0; right:0; z-index:999; background:#000; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #222; }
  .header-icon{ width:40px; height:40px; background:#111; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid #333; }
  .top-actions{ display:flex; gap:8px; align-items:center; }
  .btn-top{ display:none; border:none; padding:10px 12px; border-radius:12px; cursor:pointer; background:#111; border:1px solid #333; }
  .data-bloco{ margin-top:20px; }
  .data-titulo{ font-size:15px; font-weight:600; margin:10px 12px 8px; padding-left:8px; border-left:3px solid #007aff; display:flex; align-items:center; justify-content:space-between; }
  .toggle-icon{ cursor:pointer; width:24px; height:24px; display:flex; align-items:center; justify-content:center; }
  .grid{ display:grid; grid-template-columns:repeat(5,1fr); column-gap:6px; row-gap:8px; padding:0 10px 20px; }
  @media(max-width:640px){ .grid{ grid-template-columns:repeat(3,1fr); } .btn-top{ display:block; } }
  .foto-bloco{ position:relative; user-select:none; -webkit-user-select:none; }
  .foto-galeria{ width:100%; display:block; border-radius:6px; object-fit:cover; aspect-ratio:1/1; background:#222; cursor:pointer; }
  .check{ position:absolute; top:6px; right:6px; width:22px; height:22px; border-radius:50%; background:#fff; border:2px solid #007aff; display:flex; align-items:center; justify-content:center; font-size:12px; color:#fff; opacity:0; transition:opacity .12s; }
  .selecionado .check{ opacity:1; background:#007aff; }
  .selecionado .foto-galeria{ opacity:0.6; }
  .float-exit{ position:fixed; top:86px; right:12px; background:#ff3b30; color:#fff; border:none; padding:10px 18px; border-radius:999px; font-weight:700; display:none; z-index:2000; }
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:3000; }
  .modal[aria-hidden="false"]{ display:flex; }
  .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,0.6); }
  .modal-box{ position:relative; z-index:4; background:#111; padding:18px; border-radius:12px; width:90%; max-width:420px; color:#fff; }
  .btn-primary{ background:#007aff; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; margin-top:8px; }
  .arrastando{ opacity:0.6; transform:scale(.995); }
  /* small helper for drag handle if needed */
  .drag-handle{ position:absolute; inset:0; z-index:5; cursor:grab; background:transparent; }
  #contadorArquivos{ font-size:13px; color:#ccc; margin-top:6px; }
</style>
</head>
<body>

<div class="galeria-header">
  <div class="header-icon" onclick="window.location='index.html'">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </div>

  <div class="top-actions">
    <button id="btnComparar" class="btn-top" onclick="compararSelecionadas()">Comparar</button>
    <button id="btnEditarVarios" class="btn-top" onclick="editarSelecionados()">Editar</button>
    <button id="btnExcluirVarios" class="btn-top" onclick="excluirSelecionados()">Excluir</button>
    <div class="header-icon" onclick="abrirUpload()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 16V4m0 0l4 4m-4-4L8 8M4 16h16v4H4z" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
  </div>
</div>

<button id="btnSairSelecao" class="float-exit" onclick="sairModoSelecao()">X</button>

<div id="conteudoGaleria" style="padding-top:82px;"></div>

<!-- Modal upload -->
<div id="modalUpload" class="modal" aria-hidden="true">
  <div class="modal-backdrop" onclick="fecharUpload()"></div>
  <div class="modal-box" role="dialog" aria-modal="true">
    <h3 style="margin:0 0 8px 0;">Enviar Fotos</h3>
    <label style="display:block;margin-top:6px;">Data</label>
    <input id="uploadData" type="date" style="width:100%;padding:8px;border-radius:6px;border:1px solid #222;background:#000;color:#fff" />
    <label style="display:block;margin-top:10px;">Fotos</label>
    <input id="uploadArquivos" type="file" accept="image/*" multiple style="width:100%;color:#fff" />
    <div id="contadorArquivos"></div>
    <button class="btn-primary" onclick="enviarMultiplas()">Enviar</button>
    <div style="height:6px"></div>
  </div>
</div>

<script>
/* ====== Variáveis globais ====== */
document.addEventListener('contextmenu', e=>e.preventDefault());
let selecionadas = new Set();
const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
let selectionModeMobile = false;
window.mapaPesos = {};

/* ====== Helpers ====== */
function normalizeDate(val){
  if(!val) return "";
  const s = String(val);
  if(s.includes("T")) return s.split("T")[0];
  return s.slice(0,10);
}

/* ====== Upload ====== */
function abrirUpload(){
  document.getElementById("uploadData").value = new Date().toISOString().slice(0,10);
  document.getElementById("modalUpload").setAttribute("aria-hidden","false");
  document.getElementById("contadorArquivos").textContent = "";
  document.getElementById("uploadArquivos").value = "";
}
function fecharUpload(){ document.getElementById("modalUpload").setAttribute("aria-hidden","true"); }

document.getElementById("uploadArquivos").addEventListener("change", e=>{
  const qtd = e.target.files.length;
  document.getElementById("contadorArquivos").textContent = qtd ? `${qtd} arquivo${qtd>1?"s":""} selecionado${qtd>1?"s":""}` : "";
});

async function enviarMultiplas(){
  const data = document.getElementById("uploadData").value;
  const files = document.getElementById("uploadArquivos").files;
  if(!data || !files || files.length===0){ alert("Selecione a data e pelo menos 1 foto."); return; }
  for(const file of files){
    const nome = `${Date.now()}-${file.name}`;
    // upload to supabase storage
    await supabase.storage.from('fotos').upload(nome, file);
    const { data:pub } = supabase.storage.from('fotos').getPublicUrl(nome);
    await supabase.from('fotos').insert({ data_foto: data, url: pub.publicUrl });
  }
  fecharUpload();
  await carregarGaleria();
}

/* ====== Carregar galeria ====== */
async function carregarGaleria(){
  // limpa seleção e topo
  selecionadas.clear();
  atualizarTopo();

  // carrega pesos (mapa)
  const { data:pesos } = await supabase.from('pesos').select('data,peso');
  window.mapaPesos = {};
  (pesos||[]).forEach(p => { window.mapaPesos[ normalizeDate(p.data) ] = Number(p.peso); });

  // carrega fotos
  const { data:fotos } = await supabase.from('fotos').select('id,data_foto,url,ordem').order('data_foto', { ascending:false });
  const area = document.getElementById('conteudoGaleria');
  area.innerHTML = '';

  const grupos = {};
  (fotos||[]).forEach(f=>{
    const key = normalizeDate(f.data_foto);
    if(!grupos[key]) grupos[key]=[];
    grupos[key].push(f);
  });

  // renderiza cada grupo (data)
  const datas = Object.keys(grupos);
  for(const key of datas){
    const peso = window.mapaPesos[key];
    const labelPeso = (typeof peso === 'number') ? ` — ${peso.toFixed(1)} kg` : '';
    const bloco = document.createElement('div');
    bloco.className = 'data-bloco';
    bloco.innerHTML = `
      <div class="data-titulo">
        <span>${key}${labelPeso}</span>
        <div class="toggle-icon" data-key="${key}"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
      </div>
      <div class="grid" id="grid-${key}" style="display:none;"></div>
    `;
    area.appendChild(bloco);

    const grid = bloco.querySelector('.grid');
    // ordenar pelo campo ordem se existir, senão manter ordem do select
    const lista = grupos[key].slice().sort((a,b)=>{
      const oa = (a.ordem === null || a.ordem === undefined) ? 0 : a.ordem;
      const ob = (b.ordem === null || b.ordem === undefined) ? 0 : b.ordem;
      return oa - ob;
    });

    grid.innerHTML = lista.map(f => `
      <div class="foto-bloco" id="foto-${f.id}" data-dia="${key}">
        <div class="check">✓</div>
        <img src="${f.url}" class="foto-galeria" data-id="${f.id}" data-dia="${key}" loading="lazy" decoding="async" />
      </div>`).join('');
  }

  // anexar comportamentos (clicks/touch, etc.)
  anexarHandlers();

  // habilitar ordenacao com Sortable (apenas após DOM pronto)
  habilitarOrdenacaoComSortable();
}

/* ====== Toggle fotos por data ====== */
function toggleFotos(key){
  const grid = document.getElementById(`grid-${key}`);
  if(!grid) return;
  grid.style.display = (grid.style.display === 'none') ? 'grid' : 'none';
}

/* ====== Handlers imagens (seleção/carrossel mobile) ====== */
function anexarHandlers(){
  // toggle icon expand/collapse
  document.querySelectorAll('.toggle-icon').forEach(t=>{
    const key = t.dataset.key;
    t.onclick = ()=> toggleFotos(key);
  });

  // imagens
  document.querySelectorAll('.foto-galeria').forEach(img=>{
    const id = Number(img.dataset.id);
    const dia = img.dataset.dia;

    // remove handlers duplicados (safe)
    img.onclick = null;
    img.ondblclick = null;
    img.ontouchstart = null;
    img.ontouchmove = null;
    img.ontouchend = null;

    if(!isMobile){
      img.addEventListener('click', ()=> toggleSelecao(id));
      img.addEventListener('dblclick', ()=> abrirCarrosselDia(id, dia));
    } else {
      let pressTimer = null, startY = 0, moved = 0;
      img.addEventListener('touchstart', e=>{
        moved = 0;
        startY = e.touches[0].clientY;
        pressTimer = setTimeout(()=>{
          selectionModeMobile = true;
          document.getElementById('btnSairSelecao').style.display = 'block';
          toggleSelecao(id);
          img.classList.add('bloquearTouchEnd');
        }, 420);
      }, { passive:true });

      img.addEventListener('touchmove', e=>{
        moved = Math.abs(e.touches[0].clientY - startY);
        if(moved > 10 && pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
      }, { passive:true });

      img.addEventListener('touchend', e=>{
        if(pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
        if(moved > 10) return;
        if(img.classList.contains('bloquearTouchEnd')){ img.classList.remove('bloquearTouchEnd'); return; }
        if(selectionModeMobile) toggleSelecao(id);
        else abrirCarrosselDia(id, dia);
      }, { passive:true });
    }
  });

  // marca blocos arrastaveis para Sortable handle
  document.querySelectorAll('.foto-bloco').forEach(b => {
    b.style.touchAction = 'none'; // melhora resposta em mobile
  });
}

/* ====== Seleção / Topo ====== */
function sairModoSelecao(){
  selectionModeMobile = false;
  const btn = document.getElementById('btnSairSelecao');
  if(btn) btn.style.display = 'none';
  selecionadas.clear();
  document.querySelectorAll('.selecionado').forEach(x=>x.classList.remove('selecionado'));
  atualizarTopo();
}

function toggleSelecao(id){
  const bloco = document.getElementById(`foto-${id}`);
  if(!bloco) return;
  if(selecionadas.has(id)){
    selecionadas.delete(id);
    bloco.classList.remove('selecionado');
  } else {
    selecionadas.add(id);
    bloco.classList.add('selecionado');
  }
  atualizarTopo();
}

function atualizarTopo(){
  const n = selecionadas.size;
  document.getElementById('btnComparar').style.display = (n === 2) ? 'block' : 'none';
  document.getElementById('btnEditarVarios').style.display = (n > 0) ? 'block' : 'none';
  document.getElementById('btnExcluirVarios').style.display = (n > 0) ? 'block' : 'none';
}

/* ====== Editar / Comparar / Excluir (preservadas) ====== */
async function editarSelecionados(){
  if(selecionadas.size === 0) return;
  const nova = prompt('Nova data (AAAA-MM-DD):');
  if(!nova) return;
  for(const id of selecionadas){
    await supabase.from('fotos').update({ data_foto: nova }).eq('id', id);
  }
  selecionadas.clear();
  await carregarGaleria();
}

function compararSelecionadas(){
  if(selecionadas.size !== 2) return;
  const ids = [...selecionadas];
  const dias = [...new Set(ids.map(id => document.querySelector(`#foto-${id}`).dataset.dia))];

  if(dias.length === 1){
    // por imagem (mesma data)
    localStorage.setItem('comparar_modo', 'imagem');
    localStorage.setItem('comparar_id1', String(ids[0]));
    localStorage.setItem('comparar_id2', String(ids[1]));
  } else {
    // por data
    // mapeia ids para cada data na ordem correta
    const dia1 = document.querySelector(`#foto-${ids[0]}`).dataset.dia;
    const dia2 = document.querySelector(`#foto-${ids[1]}`).dataset.dia;
    // ordena determinístico: primeiro o dia mais antigo? Mas mantemos ordem selecionada
    localStorage.setItem('comparar_modo', 'data');
    localStorage.setItem('comparar_data1', dia1);
    localStorage.setItem('comparar_data2', dia2);
    // salva ids correspondentes
    localStorage.setItem('comparar_id1', String(ids[0]));
    localStorage.setItem('comparar_id2', String(ids[1]));
  }
  window.location = 'comparacao.html';
}

async function excluirSelecionados(){
  if(selecionadas.size === 0) return;
  if(!confirm(`Excluir ${selecionadas.size} foto(s)?`)) return;
  const bucket = 'fotos';

  const getStorageNameFromUrl = (url) => {
    if(!url) return null;
    // tenta extrair caminho do publicUrl retornado pelo supabase storage
    // formato possivel: https://.../object/public/fotos/name.ext
    let path = url.split('/object/public/')[1] || url;
    if(path.includes('?')) path = path.split('?')[0];
    path = decodeURIComponent(path);
    if(path.startsWith(bucket + '/')) path = path.slice(bucket.length + 1);
    return path || null;
  };

  const removerDoStorage = async (url) => {
    const name = getStorageNameFromUrl(url);
    if(!name) return { ok:false, msg:'URL inválida' };
    const { error } = await supabase.storage.from(bucket).remove([name]);
    if(!error) return { ok:true };
    // tentativa fallback: listar e achar similar
    const { data:lista, error:listErr } = await supabase.storage.from(bucket).list('', { limit:1000 });
    if(listErr) return { ok:false, msg:'Listagem falhou' };
    let match = lista.find(f => f.name === name) || lista.find(f => f.name.toLowerCase() === name.toLowerCase());
    if(!match){
      const base = name.split('/').pop();
      match = lista.find(f => f.name === base) || lista.find(f => f.name.toLowerCase() === base.toLowerCase());
    }
    if(match){
      const r2 = await supabase.storage.from(bucket).remove([match.name]);
      if(!r2.error) return { ok:true };
      return { ok:false, msg: 'Storage remove falhou' };
    }
    return { ok:false, msg: 'Arquivo não encontrado no bucket' };
  };

  for(const id of [...selecionadas]){
    // busca url
    const { data:foto, error:dbErr } = await supabase.from('fotos').select('url').eq('id', id).single();
    if(dbErr){ console.error('Erro ao buscar foto', dbErr); continue; }
    const r = await removerDoStorage(foto?.url);
    if(!r.ok) console.warn('Falha ao excluir do Storage', r.msg);
    await supabase.from('fotos').delete().eq('id', id);
  }

  selecionadas.clear();
  await carregarGaleria();
}

/* ====== Abrir carrossel dia (mantido) ====== */
async function abrirCarrosselDia(idClicado, dia){
  const { data } = await supabase.from('fotos').select('id,url,data_foto').eq('data_foto', dia).order('id');
  if(!data || !data.length) return;
  const items = data.map(x => ({ id: x.id, url: x.url }));
  const idx = items.findIndex(x => String(x.id) === String(idClicado));
  const peso = window.mapaPesos[dia] ?? '';
  localStorage.setItem('carousel_items', JSON.stringify(items));
  localStorage.setItem('carousel_index', String(idx));
  localStorage.setItem('carousel_dia', dia);
  localStorage.setItem('carousel_peso', String(peso));
  window.location = 'carrossel.html';
}

/* ====== Ordenação com SortableJS ====== */
function habilitarOrdenacaoComSortable(){
  // destrói instâncias antigas? Sortable cria sem referência; simples reinit ok
  document.querySelectorAll('.grid').forEach(grid => {
    // se já inicializado, Sortable atribui um property _sortable to element - evitamos duplo init
    if(grid._sortable) return;
    const s = new Sortable(grid, {
      animation: 150,
      handle: '.foto-bloco',
      draggable: '.foto-bloco',
      onEnd: async function(evt){
        const ids = [...grid.querySelectorAll('.foto-bloco')].map(b => b.id.replace('foto-',''));
        const data = grid.id.replace('grid-','');
        // salva ordem no supabase se possível
        try{
          for(let i=0;i<ids.length;i++){
            await supabase.from('fotos').update({ ordem: i }).eq('id', ids[i]);
          }
          console.log('Ordem salva', data, ids);
        }catch(e){
          console.warn('Falha ao salvar ordem', e);
        }
      }
    });
    grid._sortable = s; // marca como inicializado
  });
}

/* ====== Inicialização ====== */
carregarGaleria();

</script>
</body>
</html>
