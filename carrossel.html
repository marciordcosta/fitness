<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Visualização</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/supabase.js"></script>

<style>
body{margin:0;background:#000;overflow:hidden;touch-action:none}
#btnClose{
  position:fixed;top:12px;left:12px;z-index:2000;
  background:#ff3b30;color:#fff;border:none;
  padding:12px 18px;border-radius:12px;font-size:16px;font-weight:700
}
#infoBox{
  position:fixed;top:12px;right:12px;z-index:1800;
  background:rgba(0,0,0,.55);padding:10px 16px;
  border-radius:12px;font-size:15px;font-weight:600;color:#fff
}
.arrow{
  position:fixed;top:50%;transform:translateY(-50%);
  font-size:42px;color:#fff;padding:14px;cursor:pointer;
  user-select:none;z-index:1500
}
#leftArrow{left:10px}
#rightArrow{right:10px}
#viewer{
  width:100vw;height:100vh;display:flex;align-items:center;
  justify-content:center;overflow:hidden;position:relative
}
#imgView{
  max-width:100%;max-height:100%;object-fit:contain;
  transition:transform .1s linear;user-select:none;pointer-events:none
}
#controlsDesktop{
  position:fixed;bottom:12px;left:50%;transform:translateX(-50%);
  display:flex;gap:10px;z-index:1600
}
.btn{
  background:#1c1c1e;color:#fff;padding:10px 14px;
  border:none;border-radius:10px;cursor:pointer;font-size:14px
}
@media(max-width:640px){#controlsDesktop{display:none}}
#bottomBar{
  position:fixed;bottom:12px;right:12px;display:flex;gap:10px;z-index:1600
}
#bottomBar .btn{background:#333}
</style>
</head>
<body>

<script>
supabase.auth.getUser().then(({ data }) => {
  if (!data.user) window.location.href = "login.html";
});
</script>

<button id="btnClose" onclick="voltar()">X</button>
<div id="infoBox"></div>

<div id="viewer">
  <img id="imgView">
</div>

<div id="leftArrow" class="arrow" onclick="prev()">❮</div>
<div id="rightArrow" class="arrow" onclick="next()">❯</div>

<div id="controlsDesktop">
  <button class="btn" onclick="zoomIn()">➕</button>
  <button class="btn" onclick="zoomOut()">➖</button>
  <button class="btn" onclick="resetZoom()">Reset</button>
</div>

<div id="bottomBar">
  <button class="btn" onclick="editarFoto()">Editar Data</button>
  <button class="btn" onclick="excluirFoto()" style="background:#ff3b30;">Excluir</button>
</div>

<script>
/* ==========================================
   VARIÁVEIS (UNIFICADAS E OTIMIZADAS)
========================================== */
let fotos=[],index=0,preloaded=[];
let t={scale:1,x:0,y:0};
const imgView = ()=>document.getElementById("imgView");

/* ==========================================
   LOAD INICIAL
========================================== */
function load(){
  fotos=JSON.parse(localStorage.getItem("carousel_items")||"[]");
  index=Number(localStorage.getItem("carousel_index")||0);

  const dia = localStorage.getItem("carousel_dia")||"";
  const peso= localStorage.getItem("carousel_peso")||"";

  document.getElementById("infoBox").innerText = peso ? `${dia} — ${peso} kg` : dia;

  preloadAll();
  mostrar();
}
load();

/* ==========================================
   PRÉ-CARREGAMENTO OTIMIZADO
========================================== */
function preloadAll(){
  preloaded = fotos.map(f=>{
    const i=new Image();
    i.src=f.url;
    return i;
  });
}

/* ==========================================
   MOSTRAR IMAGEM (RENDER MINIMIZADO)
========================================== */
function mostrar(){
  if(!fotos.length) return;

  imgView().src=fotos[index].url;
  resetZoom();

  const next = preloaded[index+1];
  const prev = preloaded[index-1];
  if(next) next.src=next.src;
  if(prev) prev.src=prev.src;
}

/* ==========================================
   NAVEGAÇÃO
========================================== */
function next(){
  if(index<fotos.length-1){
    index++;
    localStorage.setItem("carousel_index",index);
    mostrar();
  }
}
function prev(){
  if(index>0){
    index--;
    localStorage.setItem("carousel_index",index);
    mostrar();
  }
}

/* ==========================================
   KEYBOARD
========================================== */
document.addEventListener("keydown",e=>{
  if(e.key==="ArrowRight") next();
  else if(e.key==="ArrowLeft") prev();
  else if(e.key==="Escape") voltar();
});

/* ==========================================
   REMOVE SWIPE (ZERO INTERFERÊNCIA)
========================================== */
document.addEventListener("touchstart",()=>{}, {passive:false});
document.addEventListener("touchend",()=>{}, {passive:false});

/* ==========================================
   ZOOM + PAN ULTRA LEVE
========================================== */
function apply(){
  imgView().style.transform=`translate(${t.x}px,${t.y}px) scale(${t.scale})`;
}
function zoomIn(){ t.scale=Math.min(t.scale+0.2,4); apply(); }
function zoomOut(){ t.scale=Math.max(t.scale-0.2,1); if(t.scale===1){t.x=0;t.y=0;} apply(); }
function resetZoom(){ t={scale:1,x:0,y:0}; apply(); }

/* ==========================================
   TOUCH ZOOM + PAN (MÁXIMA PERFORMANCE)
========================================== */
let tx=0,ty=0,td=0;

viewer.addEventListener("touchstart",e=>{
  const T=e.touches;
  if(T.length===1){ tx=T[0].clientX; ty=T[0].clientY; }
  else if(T.length===2){
    const dx=T[0].clientX - T[1].clientX;
    const dy=T[0].clientY - T[1].clientY;
    td=Math.hypot(dx,dy);
  }
},{passive:false});

viewer.addEventListener("touchmove",e=>{
  const T=e.touches;

  if(T.length===2){
    const dx=T[0].clientX - T[1].clientX;
    const dy=T[0].clientY - T[1].clientY;
    const dist=Math.hypot(dx,dy);
    if(td){
      t.scale=Math.min(Math.max(t.scale+(dist-td)/250,1),4);
      apply();
    }
    td=dist;
    return;
  }

  if(T.length===1 && t.scale>1){
    const c=T[0];
    t.x+=c.clientX-tx;
    t.y+=c.clientY-ty;
    tx=c.clientX; ty=c.clientY;
    apply();
  }
},{passive:false});

/* ==========================================
   PAN MOUSE
========================================== */
let d=false,lx=0,ly=0;

viewer.addEventListener("mousedown",e=>{
  d=true; lx=e.clientX; ly=e.clientY;
});
window.addEventListener("mouseup",()=>d=false);

window.addEventListener("mousemove",e=>{
  if(!d||t.scale<=1) return;
  t.x+=e.clientX-lx;
  t.y+=e.clientY-ly;
  lx=e.clientX; ly=e.clientY;
  apply();
});

/* ==========================================
   SAIR
========================================== */
function voltar(){ window.location="galeria.html"; }

/* ==========================================
   EDITAR
========================================== */
async function editarFoto(){
  const nova=prompt("Nova data (AAAA-MM-DD):");
  if(!nova) return;
  await supabase.from("fotos").update({data_foto:nova}).eq("id",fotos[index].id);
  alert("Data atualizada.");
}

/* ==========================================
   ✅ EXCLUIR (CORRIGIDO + OTIMIZADO)
========================================== */
async function excluirFoto(){
  if(!confirm("Excluir esta foto?")) return;

  const nome=fotos[index].arquivo;
  if(nome) await supabase.storage.from("fotos").remove([nome]);

  await supabase.from("fotos").delete().eq("id",fotos[index].id);

  fotos.splice(index,1);
  if(!fotos.length) return voltar();

  index=Math.max(0,index-1);
  localStorage.setItem("carousel_index",index);
  mostrar();
}
</script>

</body>
</html>

