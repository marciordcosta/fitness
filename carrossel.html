<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visualização</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="js/supabase.js"></script>

<style>
  body{
    margin:0;
    background:#000;
    overflow:hidden;
    touch-action:none;
  }

  /* Botão de saída */
  #btnClose{
    position:fixed;
    top:12px;
    left:12px;
    z-index:1000;
    background:#ff3b30;
    color:#fff;
    border:none;
    padding:12px 18px;
    border-radius:12px;
    font-size:16px;
    font-weight:700;
  }

  /* Setas (PC) */
  .arrow{
    position:fixed;
    top:50%;
    transform:translateY(-50%);
    font-size:42px;
    color:white;
    padding:14px;
    cursor:pointer;
    user-select:none;
    z-index:900;
  }
  #leftArrow{ left:10px; }
  #rightArrow{ right:10px; }

  /* Área da imagem */
  #viewer{
    width:100vw;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    position:relative;
  }

  #imgView{
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    transition:transform .15s ease-out;
    user-select:none;
    transform-origin:center center;
    pointer-events:none;
  }

  /* Controles PC */
  #controlsDesktop{
    position:fixed;
    bottom:12px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:10px;
    z-index:1000;
  }
  .btn{
    background:#1c1c1e;
    color:#fff;
    padding:10px 14px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
  }

  /* Mobile: controles escondidos */
  @media(max-width:640px){
    #controlsDesktop{
      display:none;
    }
  }

  /* Barra inferior - editar/excluir */
  #bottomBar{
    position:fixed;
    bottom:12px;
    right:12px;
    display:flex;
    gap:10px;
    z-index:1000;
  }
  #bottomBar .btn{
    background:#333;
  }
</style>
</head>
<body>

<button id="btnClose" onclick="voltar()">X</button>

<div id="viewer">
  <img id="imgView">
</div>

<div id="leftArrow" class="arrow" onclick="prev()">❮</div>
<div id="rightArrow" class="arrow" onclick="next()">❯</div>

<!-- Zoom Desktop -->
<div id="controlsDesktop">
  <button class="btn" onclick="zoomIn()">➕</button>
  <button class="btn" onclick="zoomOut()">➖</button>
  <button class="btn" onclick="resetZoom()">Reset</button>
</div>

<!-- Editar / Excluir -->
<div id="bottomBar">
  <button class="btn" onclick="editarFoto()">Editar Data</button>
  <button class="btn" onclick="excluirFoto()" style="background:#ff3b30;">Excluir</button>
</div>

<script>
let fotos = [];
let index = 0;

/* Transform da imagem */
let transform = { scale:1, x:0, y:0 };

function load(){
  fotos = JSON.parse(localStorage.getItem("carousel_items") || "[]");
  index = Number(localStorage.getItem("carousel_index") || 0);
  mostrar();
}
load();

/* ================= MOSTRAR FOTO ================= */
function mostrar(){
  if(!fotos.length) return;
  const img = document.getElementById("imgView");
  img.src = fotos[index].url + "?v=" + Date.now();
  resetZoom();
}

/* ================= NAVEGAÇÃO ================= */
function next(){
  if(index < fotos.length-1){
    index++;
    salvarIndex();
    mostrar();
  }
}
function prev(){
  if(index > 0){
    index--;
    salvarIndex();
    mostrar();
  }
}
function salvarIndex(){
  localStorage.setItem("carousel_index", index);
}

/* Teclado */
document.addEventListener("keydown", (e)=>{
  if(e.key === "ArrowRight") next();
  if(e.key === "ArrowLeft") prev();
  if(e.key === "Escape") voltar();
});

/* ================= SWIPE MOBILE ================= */
let startX = 0;

document.addEventListener("touchstart", e=>{
  if(e.touches.length===1){
    startX = e.touches[0].clientX;
  }
}, {passive:true});

document.addEventListener("touchend", e=>{
  const diff = e.changedTouches[0].clientX - startX;
  if(Math.abs(diff) > 60){
    if(diff < 0) next();
    else prev();
  }
}, {passive:true});

/* ================= ZOOM ================= */
function aplicar(){
  const img = document.getElementById("imgView");
  img.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
}

function zoomIn(){
  transform.scale = Math.min(transform.scale + 0.2, 4);
  aplicar();
}
function zoomOut(){
  transform.scale = Math.max(transform.scale - 0.2, 1);
  if(transform.scale === 1){
    transform.x = 0;
    transform.y = 0;
  }
  aplicar();
}
function resetZoom(){
  transform = { scale:1, x:0, y:0 };
  aplicar();
}

/* ================== PAN + PINCH ================== */
let lastTouchX = 0;
let lastTouchY = 0;
let lastTouchDist = 0;

/* TOUCH START */
viewer.addEventListener("touchstart", e=>{
  if(e.touches.length === 1){
    lastTouchX = e.touches[0].clientX;
    lastTouchY = e.touches[0].clientY;
  }
  if(e.touches.length === 2){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    lastTouchDist = Math.sqrt(dx*dx + dy*dy);
  }
}, {passive:true});

/* TOUCH MOVE */
viewer.addEventListener("touchmove", e=>{
  /* ✅ PINCH */
  if(e.touches.length === 2){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if(lastTouchDist){
      const diff = dist - lastTouchDist;
      transform.scale = Math.min(Math.max(transform.scale + diff/250, 1), 4);
      aplicar();
    }
    lastTouchDist = dist;
    return;
  }

  /* ✅ PAN */
  if(e.touches.length === 1 && transform.scale > 1){
    const t = e.touches[0];
    const dx = t.clientX - lastTouchX;
    const dy = t.clientY - lastTouchY;

    transform.x += dx;
    transform.y += dy;

    lastTouchX = t.clientX;
    lastTouchY = t.clientY;

    aplicar();
  }
}, {passive:true});

/* ================= PAN MOUSE ================= */
let dragging = false, lastX = 0, lastY = 0;

viewer.addEventListener("mousedown", e=>{
  dragging = true;
  lastX = e.clientX;
  lastY = e.clientY;
});

window.addEventListener("mouseup", ()=> dragging=false);

window.addEventListener("mousemove", e=>{
  if(!dragging || transform.scale <= 1) return;
  transform.x += (e.clientX - lastX);
  transform.y += (e.clientY - lastY);
  lastX = e.clientX;
  lastY = e.clientY;
  aplicar();
});

/* ================= SAIR ================= */
function voltar(){
  window.location.href = "galeria.html";
}

/* ================= EDITAR ================= */
async function editarFoto(){
  const nova = prompt("Nova data (AAAA-MM-DD):");
  if(!nova) return;

  await supabase.from("fotos")
    .update({ data_foto: nova })
    .eq("id", fotos[index].id);

  alert("Data atualizada.");
}

/* ================= EXCLUIR ================= */
async function excluirFoto(){
  if(!confirm("Excluir esta foto?")) return;

  const nome = fotos[index].url.split("/").pop();

  await supabase.storage.from("fotos").remove([nome]);
  await supabase.from("fotos").delete().eq("id", fotos[index].id);

  fotos.splice(index,1);

  if(fotos.length === 0){
    voltar();
  } else {
    index = Math.max(0, index-1);
    salvarIndex();
    mostrar();
  }
}
</script>

</body>
</html>
